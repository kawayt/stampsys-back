<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.stampsysback.mapper.StampSummaryMapper">

    <!--
      目的：
      - ルームに紐づくスタンプ一覧（stamps JOIN stamps_classes JOIN rooms を基準）を全て出力する
      - 参加者の「最新押下」を基に各スタンプの件数を集計（未押下は cnt=0 のまま出す）
      - 参加者の最新が NULL（未押下）な人数を NO_STAMP 行として出力
    -->

    <select id="findLatestStampDistributionByRoomId" resultType="com.example.stampsysback.dto.StampSummary">
        WITH participants AS (
            SELECT uc.user_id
            FROM rooms r
                     JOIN classes c ON r.class_id = c.class_id
                     JOIN users_classes uc ON c.class_id = uc.class_id
            WHERE r.room_id = #{roomId}
        ),
             ranked AS (
                 SELECT
                     user_id,
                     stamp_id,
                     sent_at,
                     ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY sent_at DESC, stamp_log_id DESC) AS rn
                 FROM stamp_logs
                 WHERE room_id = #{roomId}
             ),
             latest_per_user AS (
                 SELECT user_id, stamp_id
                 FROM ranked
                 WHERE rn = 1
             ),
             joined AS (
                 SELECT p.user_id, l.stamp_id
                 FROM participants p
                          LEFT JOIN latest_per_user l ON p.user_id = l.user_id
             ),
             total AS (
                 SELECT COUNT(*) AS total_cnt FROM participants
             ),
             cnts AS (
                 -- latest が NULL (未押下) の行は除外して各 stamp_id ごとの件数を取る
                 SELECT j.stamp_id, COUNT(*) AS cnt
                 FROM joined j
                 WHERE j.stamp_id IS NOT NULL
                 GROUP BY j.stamp_id
             ),
             room_stamps AS (
                 -- ルームに紐づくスタンプ一覧（あなたの stamps 取得経路を利用）
                 SELECT s.stamp_id, s.stamp_name, s.stamp_color, s.stamp_icon
                 FROM stamps s
                          JOIN stamps_classes sc ON s.stamp_id = sc.stamp_id
                          JOIN rooms r ON sc.class_id = r.class_id
                 WHERE r.room_id = #{roomId}
             )

        -- 1) ルームの全スタンプ（押されていないものは cnt=0）
        SELECT
            s.stamp_id AS stampId,
            s.stamp_name AS stampName,
            s.stamp_color AS stampColor,
            s.stamp_icon AS stampIcon,
            COALESCE(c.cnt, 0)::integer AS cnt,
            ROUND((COALESCE(c.cnt, 0)::numeric / GREATEST(total.total_cnt, 1)::numeric) * 100.0, 2) AS pct
        FROM room_stamps s
                 LEFT JOIN cnts c ON s.stamp_id = c.stamp_id
                 CROSS JOIN total

        UNION ALL

        -- 2) 未押下（NO_STAMP）行：latest_per_user が NULL の人数
        SELECT
            -1 AS stampId,
            'NO_STAMP' AS stampName,
            NULL AS stampColor,
            NULL AS stampIcon,
            (SELECT COUNT(*) FROM joined j2 WHERE j2.stamp_id IS NULL)::integer AS cnt,
            ROUND(((SELECT COUNT(*) FROM joined j2 WHERE j2.stamp_id IS NULL)::numeric / GREATEST(total.total_cnt, 1)::numeric) * 100.0, 2) AS pct
        FROM total

        ORDER BY cnt DESC
        ;
    </select>

</mapper>