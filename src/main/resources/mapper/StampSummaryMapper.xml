<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.stampsysback.mapper.StampSummaryMapper">

    <!--
      仕様：
      - participants: rooms -> classes -> users_classes から取得するクラスのメンバー（参加者）
      - latest_per_user: 各 user のその room における最新押下（ROW_NUMBER を使用）
      - joined: participants LEFT JOIN latest_per_user により、未押下ユーザは stamp_id = NULL になる
      - total: 参加者総数を分母にして割合を算出（未押下含む）
      - 出力：stampId, stampName, cnt, pct
    -->

    <select id="findLatestStampDistributionByRoomId" resultType="com.example.stampsysback.dto.StampSummary">
        WITH participants AS (
            SELECT uc.user_id
            FROM rooms r
                     JOIN classes c ON r.class_id = c.class_id
                     JOIN users_classes uc ON c.class_id = uc.class_id
            WHERE r.room_id = #{roomId}
        ),
             ranked AS (
                 SELECT
                     user_id,
                     stamp_id,
                     sent_at,
                     ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY sent_at DESC, stamp_log_id DESC) AS rn
                 FROM stamp_logs
                 WHERE room_id = #{roomId}
             ),
             latest_per_user AS (
                 SELECT user_id, stamp_id
                 FROM ranked
                 WHERE rn = 1
             ),
             joined AS (
                 SELECT p.user_id, l.stamp_id
                 FROM participants p
                          LEFT JOIN latest_per_user l ON p.user_id = l.user_id
             ),
             total AS (
                 SELECT COUNT(*) AS total_cnt FROM participants
             )
        SELECT
            COALESCE(s.stamp_id, -1) AS stampId,
            COALESCE(s.stamp_name, 'NO_STAMP') AS stampName,
            s.stamp_color AS stampColor,
            s.stamp_icon AS stampIcon,
            COUNT(*) AS cnt,
            ROUND( (COUNT(*)::numeric / GREATEST(total.total_cnt,1)::numeric) * 100.0, 2) AS pct
        FROM joined j
                 LEFT JOIN stamps s ON j.stamp_id = s.stamp_id
                 CROSS JOIN total
        GROUP BY COALESCE(s.stamp_id, -1), COALESCE(s.stamp_name, 'NO_STAMP'), s.stamp_color, s.stamp_icon, total.total_cnt
        ORDER BY cnt DESC
        ;
    </select>

</mapper>