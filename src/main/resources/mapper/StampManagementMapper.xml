<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.stampsysback.mapper.StampManagementMapper">

    <!-- スタンプ一覧取得 -->
    <select id="findAll" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            stamp_id    AS stampId,
            stamp_name  AS stampName,
            stamp_icon  AS stampIcon,
            stamp_color AS stampColor,
            user_id     AS userId,
            FALSE AS assigned
        FROM stamps
        WHERE hidden = FALSE  ORDER BY stamp_id;
    </select>

    <!-- 自分が作成したスタンプのみ取得 -->
    <select id="selectByUserId" parameterType="int" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            stamp_id    AS stampId,
            stamp_name  AS stampName,
            stamp_icon  AS stampIcon,
            stamp_color AS stampColor,
            user_id     AS userId,
            FALSE       AS assigned
        FROM stamps
        WHERE hidden = FALSE
          AND user_id = #{userId}
        ORDER BY stamp_id;
    </select>

    <!-- 追加: 指定クラスに紐づく（assigned）スタンプ一覧 -->
    <select id="selectStampsByClassId" parameterType="int" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            s.stamp_id    AS stampId,
            s.stamp_name  AS stampName,
            s.stamp_icon  AS stampIcon,
            s.stamp_color AS stampColor,
            s.user_id     AS userId,
            TRUE          AS assigned
        FROM stamps s
                 INNER JOIN stamps_classes sc ON s.stamp_id = sc.stamp_id
        WHERE sc.class_id = #{classId}
          AND s.hidden = FALSE  ORDER BY s.stamp_id
    </select>

    <!-- 追加: 指定クラスに紐づいていない（unassigned）スタンプ一覧 -->
    <select id="selectStampsNotInClassId" parameterType="int" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            s.stamp_id    AS stampId,
            s.stamp_name  AS stampName,
            s.stamp_icon  AS stampIcon,
            s.stamp_color AS stampColor,
            s.user_id     AS userId,
            FALSE         AS assigned
        FROM stamps s
        WHERE s.hidden = FALSE  AND NOT EXISTS (
            SELECT 1 FROM stamps_classes sc WHERE sc.stamp_id = s.stamp_id AND sc.class_id = #{classId}
        )
        ORDER BY s.stamp_id
    </select>

    <!-- 新しいスタンプ追加 -->
    <insert id="insert" parameterType="com.example.stampsysback.dto.StampManagementRequest" useGeneratedKeys="true" keyProperty="stampId">
        INSERT INTO stamps (stamp_name, stamp_icon, stamp_color, user_id, hidden)
        VALUES (#{stampName}, #{stampIcon}, #{stampColor}, #{userId}, FALSE)
    </insert>

    <!-- スタンプ論理削除 -->
    <!-- TRUE：削除 | FALSE：有効 -->
    <update id="delete" parameterType="int">
        UPDATE stamps
        SET hidden = TRUE
        WHERE stamp_id = #{stampId}
    </update>

    <!-- 【追加】スタンプ復元 -->
    <update id="restore" parameterType="int">
        UPDATE stamps
        SET hidden = FALSE
        WHERE stamp_id = #{stampId}
    </update>

    <!-- 論理削除されたスタンプ一覧取得 -->
    <select id="selectDeleted" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            stamp_id    AS stampId,
            stamp_name  AS stampName,
            stamp_icon  AS stampIcon,
            stamp_color AS stampColor,
            user_id     AS userId,
            FALSE       AS assigned
        FROM stamps
        WHERE hidden = TRUE
        ORDER BY stamp_id
    </select>
</mapper>
