<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.stampsysback.mapper.StampManagementMapper">

    <!-- スタンプ一覧取得 -->
    <select id="findAll" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
        stamp_id    AS stampId,
        stamp_name  AS stampName,
        stamp_icon  AS stampIcon,
        stamp_color AS stampColor,
        FALSE AS assigned
        FROM stamps
        WHERE stamp_deleted = FALSE
        ORDER BY stamp_id;
    </select>

    <!-- 追加: 指定クラスに紐づく（assigned）スタンプ一覧 -->
    <select id="selectStampsByClassId" parameterType="int" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            s.stamp_id    AS stampId,
            s.stamp_name  AS stampName,
            s.stamp_icon  AS stampIcon,
            s.stamp_color AS stampColor,
            TRUE          AS assigned
        FROM stamps s
                 INNER JOIN stamps_classes sc ON s.stamp_id = sc.stamp_id
        WHERE sc.class_id = #{classId}
          AND s.stamp_deleted = FALSE
        ORDER BY s.stamp_id
    </select>

    <!-- 追加: 指定クラスに紐づいていない（unassigned）スタンプ一覧 -->
    <select id="selectStampsNotInClassId" parameterType="int" resultType="com.example.stampsysback.dto.StampManagementResponse">
        SELECT
            s.stamp_id    AS stampId,
            s.stamp_name  AS stampName,
            s.stamp_icon  AS stampIcon,
            s.stamp_color AS stampColor,
            FALSE         AS assigned
        FROM stamps s
        WHERE s.stamp_deleted = FALSE
          AND NOT EXISTS (
            SELECT 1 FROM stamps_classes sc WHERE sc.stamp_id = s.stamp_id AND sc.class_id = #{classId}
        )
        ORDER BY s.stamp_id
    </select>

    <!-- 新しいスタンプ追加 -->
    <insert id="insert" parameterType="com.example.stampsysback.dto.StampManagementRequest" useGeneratedKeys="true" keyProperty="stampId">
        INSERT INTO stamps (stamp_name, stamp_icon, stamp_color)
        VALUES (#{stampName}, #{stampIcon}, #{stampColor})
    </insert>

    <!-- スタンプ論理削除 -->
    <!-- TRUE：削除 | FALSE：有効 -->
    <update id="delete" parameterType="int">
        UPDATE stamps
        SET stamp_deleted = TRUE
        WHERE stamp_id = #{stampId}
    </update>

</mapper>
