<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.stampsysback.mapper.RoomMapper">

    <resultMap id="RoomResult" type="com.example.stampsysback.entity.RoomEntity">
        <id     column="room_id"   property="roomId"/>
        <result column="room_name" property="roomName"/>
        <result column="class_id"  property="classId"/>
        <result column="active"    property="active"/>
        <result column="hidden"    property="hidden" />
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- room の name を返す -->
    <select id="findRoomNameByRoomId" parameterType="int" resultType="string">
        SELECT room_name
        FROM rooms
        WHERE room_id = #{roomId}
            LIMIT 1
    </select>

    <!--hidden=falseを返す-->
    <select id="selectByClassId"
            parameterType="int"
            resultMap="RoomResult">
        SELECT room_id, room_name, class_id, active, hidden, created_at
        FROM rooms
        WHERE class_id = #{classId} AND hidden = false
        ORDER BY room_id DESC
    </select>

    <!--hidden=trueを返す-->
    <select id="selectHiddenByClassId"
            parameterType="int"
            resultMap="RoomResult">
        SELECT room_id, room_name, class_id, active, hidden, created_at
        FROM rooms
        WHERE class_id = #{classId} AND hidden = true
        ORDER BY room_id DESC
    </select>

    <!--  selectByClassIdと何が違うのか  -->
    <select id="selectAllByClassId" parameterType="int" resultMap="RoomResult">
        SELECT room_id, room_name, class_id, active, hidden, created_at
        FROM rooms
        WHERE class_id = #{classId} AND hidden = false
        ORDER BY room_id DESC
    </select>

    <select id="selectById" parameterType="int" resultMap="RoomResult">
        SELECT room_id, room_name, class_id, active, hidden, created_at
        FROM rooms
        WHERE room_id = #{roomId}
    </select>

    <insert id="insert" parameterType="com.example.stampsysback.entity.RoomEntity">
        INSERT INTO rooms (room_id, room_name, class_id, active, created_at)
        VALUES (#{roomId}, #{roomName}, #{classId}, #{active}, #{createdAt})
    </insert>

    <select id="selectMaxRoomId" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(room_id), 0) FROM rooms
    </select>

    <select id="findClassIdByRoomId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT class_id
        FROM rooms
        WHERE room_id = #{roomId}
    </select>

    <update id="updateActiveById">
        UPDATE rooms
        SET active = #{active}
        WHERE room_id = #{roomId}
    </update>

    <update id="updateHiddenById">
        UPDATE rooms
        SET hidden = #{hidden}
        WHERE room_id = #{roomId}
    </update>

    <select id="selectByNameAndClass" resultMap="RoomResult" parameterType="map">
        SELECT room_id, room_name, class_id, active, hidden, created_at
        FROM rooms
        WHERE room_name = #{roomName} AND class_id = #{classId} AND hidden = false
            LIMIT 1
    </select>

    <!-- 追加: 指定クラスに紐づく最新の active=true な room の room_id を1件取得 -->
    <select id="selectLatestActiveRoomIdByClassId" parameterType="int" resultType="java.lang.Integer">
        SELECT room_id
        FROM rooms
        WHERE class_id = #{classId}
          AND active = TRUE
        ORDER BY created_at DESC
            LIMIT 1
    </select>

    <!-- 指定したクラスのactive=trueをfalseにする -->
    <update id="updateDeactivateByClassId" parameterType="int">
        UPDATE rooms
        SET active = FALSE
        WHERE class_id = #{classId} AND active = TRUE
    </update>

</mapper>