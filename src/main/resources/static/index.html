<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSRF / stamp-send テストページ（GET/POST）</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; padding: 20px; }
        label { display:block; margin-top:10px; }
        input, select { padding:6px; width:240px; }
        button { margin-top:10px; padding:8px 12px; }
        pre { background:#f6f8fa; padding:10px; border:1px solid #ddd; white-space:pre-wrap; }
        .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    </style>
</head>
<body>
<h1>CSRF / API テストページ（GET / POST）</h1>

<p>開発用：ブラウザで OAuth2 ログイン済みのセッションを使って、GET/POST の送信内容とサーバ応答を確認できます。必ず http://localhost:5173 等から配信してください（file:// だと CORS の挙動が異なります）。</p>

<div class="row">
    <button id="btn-get-token">トークン取得 (/api/csrf)</button>
    <button id="btn-show-cookies">document.cookie を表示</button>
    <button id="btn-open-login">OAuth2 ログイン (ブラウザで開く)</button>
</div>

<div style="margin-top:12px;">
    <label>取得トークン（X-XSRF-TOKEN に入れる値）</label>
    <pre id="token">-- まだ取得されていません --</pre>
</div>

<hr/>

<h2>共通パラメータ</h2>
<div class="row">
    <label>API ベース URL <input id="apiBase" value="http://localhost:8080" /></label>
</div>

<hr/>

<h2>GET テスト</h2>
<p>エンドポイントとクエリを指定して GET を送信します（例: /api/some-endpoint?param=1）。</p>
<div>
    <label>エンドポイント path <input id="getPath" value="/api/stamp-send" /></label>
    <div class="row">
        <label>userId <input type="number" id="getUserId" value="1" /></label>
        <label>roomId <input type="number" id="getRoomId" value="2" /></label>
        <label>stampId <input type="number" id="getStampId" value="3" /></label>
    </div>
    <div class="row">
        <button id="btn-send-get">GET 送信</button>
        <label><input type="checkbox" id="getIncludeToken" checked /> XSRF トークンをヘッダに付与</label>
    </div>
</div>

<hr/>

<h2>POST テスト</h2>
<form id="stamp-form" style="margin-top:12px;">
    <label>POST エンドポイント path <input id="postPath" value="/api/stamp-send" /></label>
    <div class="row">
        <label>userId <input type="number" id="postUserId" value="1" /></label>
        <label>roomId <input type="number" id="postRoomId" value="2" /></label>
        <label>stampId <input type="number" id="postStampId" value="3" /></label>
    </div>
    <div class="row">
        <button type="submit">POST 送信</button>
        <label><input type="checkbox" id="postIncludeToken" checked /> XSRF トークンをヘッダに付与</label>
    </div>
</form>

<h3>サーバ応答</h3>
<pre id="response">-- まだ応答なし --</pre>

<script>
    const tokenEl = document.getElementById('token');
    const respEl = document.getElementById('response');

    document.getElementById('btn-get-token').addEventListener('click', async () => {
        const apiBase = document.getElementById('apiBase').value;
        try {
            respEl.textContent = 'トークン取得中...';
            const res = await fetch(apiBase + '/api/csrf', {
                method: 'GET',
                credentials: 'include'
            });
            const text = await res.text();
            try {
                const json = JSON.parse(text);
                tokenEl.textContent = json.token || '(no token in response)';
            } catch (e) {
                tokenEl.textContent = text;
            }
            respEl.textContent = `GET /api/csrf -> ${res.status} ${res.statusText}`;
        } catch (err) {
            respEl.textContent = 'エラー: ' + err.toString();
        }
    });

    document.getElementById('btn-show-cookies').addEventListener('click', () => {
        tokenEl.textContent = document.cookie || '(document.cookie is empty)';
    });

    document.getElementById('btn-open-login').addEventListener('click', () => {
        const apiBase = document.getElementById('apiBase').value;
        window.open(apiBase + '/oauth2/authorization/microsoft', '_blank');
    });

    function buildQuery(params) {
        const esc = v => encodeURIComponent(v);
        return Object.keys(params)
            .filter(k => params[k] !== null && params[k] !== undefined && params[k] !== '')
            .map(k => `${esc(k)}=${esc(params[k])}`)
            .join('&');
    }

    document.getElementById('btn-send-get').addEventListener('click', async () => {
        const apiBase = document.getElementById('apiBase').value;
        const path = document.getElementById('getPath').value;
        const params = {
            userId: document.getElementById('getUserId').value,
            roomId: document.getElementById('getRoomId').value,
            stampId: document.getElementById('getStampId').value
        };
        const qs = buildQuery(params);
        const url = apiBase.replace(/\/$/, '') + path + (qs ? ('?' + qs) : '');
        const includeToken = document.getElementById('getIncludeToken').checked;
        respEl.textContent = `GET 送信: ${url}\n\n送信中...`;
        try {
            const headers = {};
            if (includeToken && tokenEl.textContent && tokenEl.textContent !== '-- まだ取得されていません --') {
                headers['X-XSRF-TOKEN'] = tokenEl.textContent;
            }
            const res = await fetch(url, {
                method: 'GET',
                credentials: 'include',
                headers
            });
            await showResponse(res, url, 'GET', params);
        } catch (err) {
            respEl.textContent = 'GET エラー: ' + err.toString();
        }
    });

    document.getElementById('stamp-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const apiBase = document.getElementById('apiBase').value;
        const path = document.getElementById('postPath').value;
        const url = apiBase.replace(/\/$/, '') + path;
        const body = {
            userId: Number(document.getElementById('postUserId').value),
            roomId: Number(document.getElementById('postRoomId').value),
            stampId: Number(document.getElementById('postStampId').value)
        };
        const includeToken = document.getElementById('postIncludeToken').checked;
        respEl.textContent = `POST 送信: ${url}\n\n送信中...`;
        try {
            const headers = { 'Content-Type': 'application/json' };
            if (includeToken && tokenEl.textContent && tokenEl.textContent !== '-- まだ取得されていません --') {
                headers['X-XSRF-TOKEN'] = tokenEl.textContent;
            }
            const res = await fetch(url, {
                method: 'POST',
                credentials: 'include',
                headers,
                body: JSON.stringify(body)
            });
            await showResponse(res, url, 'POST', body);
        } catch (err) {
            respEl.textContent = 'POST エラー: ' + err.toString();
        }
    });

    async function showResponse(res, url, method, sentData) {
        const headersObj = {};
        for (const [k, v] of res.headers.entries()) headersObj[k] = v;
        let bodyText = '';
        try {
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                bodyText = JSON.stringify(await res.json(), null, 2);
            } else {
                bodyText = await res.text();
            }
        } catch (e) {
            bodyText = '(レスポンスボディの読み取りでエラー)';
        }
        respEl.textContent =
            `${method} ${url}\n\nStatus: ${res.status} ${res.statusText}\n\nSent:\n${JSON.stringify(sentData, null, 2)}\n\nResponse headers:\n${JSON.stringify(headersObj, null, 2)}\n\nResponse body:\n${bodyText}`;
    }
</script>
</body>
</html>